# Shared healthcheck definitions
x-healthchecks:
  rabbitmq: &rabbitmq-healthcheck
    test: [ "CMD", "rabbitmq-diagnostics", "-q", "ping" ]
    interval: 10s
    timeout: 5s
    retries: 12

  sqlserver: &sqlserver-healthcheck
    test:
      [ "CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U ${DB_USER} -P ${DB_PASSWORD} -Q 'SELECT 1' -C || exit 1" ]
    interval: 10s
    timeout: 5s
    retries: 10

services:
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck: *rabbitmq-healthcheck

  order-db:
    image: "${DB_IMAGE}"
    platform: "${DB_PLATFORM}"
    container_name: order-db
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "${DB_PASSWORD}"
    ports:
      - "14332:1433"
    healthcheck: *sqlserver-healthcheck
  
  inventory-db:
    image: "${DB_IMAGE}"
    platform: "${DB_PLATFORM}"
    container_name: inventory-db
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "${DB_PASSWORD}"
    ports:
      - "14333:1433"
    healthcheck: *sqlserver-healthcheck

  inventoryservice:
    build:
      context: .
      dockerfile: src/InventoryService/InventoryService.Api/Dockerfile
    container_name: inventoryservice
    environment:
      - ConnectionStrings__InventoryDb=Server=inventory-db,1433;Database=InventoryDb;User ID=${DB_USER};Password=${DB_PASSWORD};TrustServerCertificate=True
    depends_on:
      inventory-db:
        condition: service_healthy
    ports:
      - "5002:8080"

  orderservice:
    build:
      context: .
      dockerfile: src/OrderService/OrderService.Api/Dockerfile
    container_name: orderservice
    environment:
      - ConnectionStrings__OrderDb=Server=order-db,1433;Database=OrderDb;User ID=${DB_USER};Password=${DB_PASSWORD};TrustServerCertificate=True
      - Inventory__BaseUrl=http://inventoryservice:8080
      - RabbitMQ__Host=rabbitmq
    depends_on:
      order-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      inventoryservice:
        condition: service_started
    ports:
      - "5001:8080"

  notificationservice:
    build:
      context: .
      dockerfile: src/NotificationService/NotificationService.Worker/Dockerfile
    container_name: notificationservice
    environment:
      - RabbitMQ__Host=rabbitmq
    depends_on:
      rabbitmq:
        condition: service_healthy

  gateway:
    build:
      context: .
      dockerfile: src/Gateway/Gateway.Api/Dockerfile
    container_name: gateway
    ports:
      - "5003:8080"
    environment:
      AuthenticationProviderKey: "${AUTHENTICATION_PROVIDER_KEY}"
    depends_on:
      orderservice:
        condition: service_started
      inventoryservice:
        condition: service_started